<!DOCTYPE html>
<html>
{% load static %}
<head>
    <title>Shared Buffer</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="{% static 'css/main.css' %}" rel="stylesheet">
{#    <link href="https://cdn.alloyui.com/3.0.1/aui-css/css/bootstrap.min.css" rel="stylesheet"/>#}
</head>

<script src="https://cdn.alloyui.com/3.0.1/aui/aui-min.js"></script>

<script type="text/javascript">
    const TEXT_CHANGE_TIMEOUT = 500;

    getIdFromPath = function () {
        const pathComponents = window.location.pathname.split('/');
        return pathComponents[pathComponents.length - 1];
    };

    window.onload = function () {

        YUI().use(
            'aui-ace-editor',
            function (Y) {
                const editor = new Y.AceEditor(
                    {
                        boundingBox: '#code-editor',
                        mode: 'java',
                        value: 'System.out.println(System.in.getln(System.what.isit("kakoune\\n")))',
                        width: screen.width / 2,
                        height: screen.height / 4
                    }
                ).render();

                const mode = Y.one('#mode');

                if (mode) {
                    const contents = {
                        haskell: 'newtype Arr2 e1 e2 a = Arr2 { getArr2 :: e1 -> e2 -> a }\n' +
                        'newtype Arr3 e1 e2 e3 a = Arr3 { getArr3 :: e1 -> e2 -> e3 -> a }\n' +
                        '\n' +
                        'instance Functor (Arr2 e1 e2) where\n' +
                        '  fmap f (Arr2 g) = Arr2 (((.) . (.)) f g)\n' +
                        '\n' +
                        'instance Functor (Arr3 e1 e2 e3) where\n' +
                        '  fmap f (Arr3 g) = Arr3 (((.) . (.) . (.)) f g)\n' +
                        '\n' +
                        'instance Applicative (Arr2 e1 e2) where\n' +
                        '  pure x = Arr2 (\\e1 e2 -> x)\n' +
                        '  -- (<*>) :: (e1 -> e2 -> a -> b) -> (e1 -> e2 -> a) -> (e1 -> e2 -> b)\n' +
                        '  (<*>) (Arr2 f) (Arr2 g) = Arr2 (\\e1 e2 -> f e1 e2 (g e1 e2))\n' +
                        '\n' +
                        'instance Applicative (Arr3 e1 e2 e3) where\n' +
                        '  pure x = Arr3 (\\e1 e2 e3 -> x)\n' +
                        '  (<*>) (Arr3 f) (Arr3 g) = Arr3 (\\e1 e2 e3 -> f e1 e2 e3 (g e1 e2 e3))\n',
                        java: 'System.out.println(System.in.getln(System.what.isit("kakoune\\n")))',
                        python: 'print(peremennaya6, functsiya(massiv[5,81764]))'
                    };

                    let currentMode = 'java';

                    const updateValue = function () {
                        editor.set('value', contents[currentMode]);
                    };

                    mode.on(
                        'change',
                        function (event) {
                            currentMode = this.val();
                            editor.set('mode', currentMode);
                            updateValue();
                        }
                    );
                }

                service.onmessage = function (event) {
                    console.log("sent data are: " + event.data);
                    const input = JSON.parse(event.data);
                    console.log("parse: " + input.message);
                    editor.set('value', input.message);
                };

                codeEditor.onkeydown = function (e) {
                    clearTimeout(this.timeout);
                    this.timeout = setTimeout(() => {
                        console.log(editor.get('value'));
                        const payload = JSON.stringify({
                            role: 'editor',
                            buffer_id: getIdFromPath(),
                            message: editor.get('value')
                        });
                        service.send(payload);
                    }, TEXT_CHANGE_TIMEOUT);
                };
            }
        );

        const codeEditor = document.getElementById("code-editor");
        const bufferTextarea = document.getElementById("buffer-textarea");

{#        bufferTextarea.timeout = null;#}
        const service = new WebSocket("ws://" + window.location.host + "/buffer/edit");
        service.onopen = function (event) {
            console.log(event);
            const payload = JSON.stringify({
                role: 'editor',
                buffer_id: getIdFromPath(),
            });
            service.send(payload);
        };
        service.onclose = function () {
            console.log("closed");
            alert("The connection was closed! Someone might be editing this page already.")
        };
        service.onerror = function () {
            console.log("error");
        };
        {#        service.onmessage = function (event) {#}
        {#            console.log("sent data are: " + event.data);#}
        {#            const input = JSON.parse(event.data);#}
        {#            console.log("parse: " + input.message);#}
        {#            bufferTextarea.value = input.message;#}
        {#        };#}

        {#        bufferTextarea.onkeydown = function (e) {#}
        {#            clearTimeout(this.timeout);#}
        {#            this.timeout = setTimeout(() => {#}
        {#                const payload = JSON.stringify({#}
        {#                    role: 'editor',#}
        {#                    buffer_id: getIdFromPath(),#}
        {#                    message: this.value#}
        {#                });#}
        {#                service.send(payload);#}
        {#            }, TEXT_CHANGE_TIMEOUT);#}
        {#        };#}
    };
</script>

<body>
<div class="my-container">

    <h1 id="buffer-title">This is Buffer</h1>
    <table>
        <tr>
            <td>
                <div id="myWrapper">
                    <form class="form">
                        <div class="form-group">
                            <label for="mode" class="control-label">Language Mode:</label>
                            <select id="mode" class="form-control">
                                <option>java</option>
                                <option>haskell</option>
                                <option>python</option>
                            </select>
                        </div>
                    </form>
                    <div id="code-editor"></div>
                </div>
            </td>
        </tr>
    </table>
    <label id="public_url">Share this with your slaves:
        <a href="/buffer/read/{{ public_key }}">
            https://buffersonline.com/read/{{ public_key }}
        </a>
    </label>

</div>
</body>

</html>
