<!DOCTYPE html>
<html>
{% load static %}
<head>
    <title>Shared Buffer</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="{% static 'css/main.css' %}" rel="stylesheet">
</head>

<script type="text/javascript">
    const TEXT_CHANGE_TIMEOUT = 500;

    getIdFromPath = function () {
        const pathComponents = window.location.pathname.split('/');
        return pathComponents[pathComponents.length - 1];
    };

    window.onload = function () {
        const bufferTextarea = document.getElementById("buffer-textarea");
        const publicKeyHolder = document.getElementById("public_url");

        bufferTextarea.timeout = null;
        const service = new WebSocket("ws://" + window.location.host + "/buffer/edit");
        service.onopen = function (event) {
            console.log(event);
            const payload = JSON.stringify({
                role: 'editor',
                buffer_id: getIdFromPath(),
            });
            service.send(payload);
        };
        service.onclose = function () {
            console.log("closed");
            alert("The connection was closed! Someone might be editing this page already.")
        };
        service.onerror = function () {
            console.log("error");
        };
        service.onmessage = function (event) {
            console.log("sent data are: " + event.data);
            const input = JSON.parse(event.data);
            console.log("parse: " + input.message);
            bufferTextarea.value = input.message;
        };

        bufferTextarea.onkeydown = function (e) {
            clearTimeout(this.timeout);
            this.timeout = setTimeout(() => {
                const payload = JSON.stringify({
                    role: 'editor',
                    buffer_id: getIdFromPath(),
                    message: this.value
                });
                service.send(payload);
            }, TEXT_CHANGE_TIMEOUT);
        };
    };
</script>

<body>
<div class="my-container">

    <h1 id="buffer-title">This is Buffer</h1>
    <textarea id="buffer-textarea" class="read-textarea" rows="4" cols="10">
    </textarea>
    <label id="public_url">Share this with your slaves:
        <a href="/buffer/read/{{ public_key }}">
            https://buffersonline.com/read/{{ public_key }}
        </a>
    </label>

</div>
</body>

</html>
